// 落地页的翻译表
const landingTranslations = {
    "landing_subtitle": {
        "zh-CN": "一个强大的浏览器扩展，帮助您快速清理网站缓存、分析页面性能并提供全面的数据管理方案。",
        "en": "A powerful browser extension that helps you quickly clean website cache, analyze page performance and provide comprehensive data management solutions."
    },
    "landing_install_button": {
        "zh-CN": "立即安装",
        "en": "Install Now"
    },
    "landing_features_title": {
        "zh-CN": "主要功能",
        "en": "Key Features"
    },
    "landing_feature_smart_clean_title": {
        "zh-CN": "智能清理",
        "en": "Smart Cleaning"
    },
    "landing_feature_smart_clean_desc": {
        "zh-CN": "支持智能和自定义两种清理模式，精确清理当前网站的缓存数据，无需清理整个浏览器的缓存。",
        "en": "Supports both smart and custom cleaning modes, accurately cleans cache data of the current website without clearing the entire browser cache."
    },
    "landing_feature_quick_refresh_title": {
        "zh-CN": "快速刷新",
        "en": "Quick Refresh"
    },
    "landing_feature_quick_refresh_desc": {
        "zh-CN": "清理后自动刷新页面，立即获得最新内容，加快网页加载速度。",
        "en": "Automatically refreshes the page after cleaning to immediately get the latest content and speed up page loading."
    },
    "landing_feature_performance_title": {
        "zh-CN": "性能分析",
        "en": "Performance Analysis"
    },
    "landing_feature_performance_desc": {
        "zh-CN": "全面分析页面性能指标、资源分布和优化建议，以可视化方式展示关键性能数据。",
        "en": "Comprehensively analyzes page performance metrics, resource distribution, and optimization suggestions, displaying key performance data visually."
    },
    "landing_feature_custom_rules_title": {
        "zh-CN": "自定义规则",
        "en": "Custom Rules"
    },
    "landing_feature_custom_rules_desc": {
        "zh-CN": "创建和管理网站清理规则，支持导入导出设置，满足个性化需求。",
        "en": "Create and manage website cleaning rules, supporting import and export of settings to meet personalized needs."
    },
    "landing_feature_ui_title": {
        "zh-CN": "界面优化",
        "en": "UI Optimization"
    },
    "landing_feature_ui_desc": {
        "zh-CN": "全新侧边栏导航设计，提供更清晰直观的用户体验和操作流程。",
        "en": "New sidebar navigation design, providing a clearer and more intuitive user experience and operation process."
    },
    "landing_feature_i18n_title": {
        "zh-CN": "多语言支持",
        "en": "Multilingual Support"
    },
    "landing_feature_i18n_desc": {
        "zh-CN": "支持中英文国际化，适应不同用户的语言偏好。",
        "en": "Supports Chinese and English internationalization to adapt to different user language preferences."
    },
    "landing_how_to_use_title": {
        "zh-CN": "如何使用",
        "en": "How To Use"
    },
    "landing_step_install_title": {
        "zh-CN": "安装扩展",
        "en": "Install Extension"
    },
    "landing_step_install_desc": {
        "zh-CN": "从浏览器应用商店安装ClearPage扩展。",
        "en": "Install the ClearPage extension from your browser's app store."
    },
    "landing_step_click_title": {
        "zh-CN": "点击图标",
        "en": "Click Icon"
    },
    "landing_step_click_desc": {
        "zh-CN": "在需要清理缓存的网站上点击ClearPage图标。",
        "en": "Click the ClearPage icon on the website where you need to clean the cache."
    },
    "landing_step_select_title": {
        "zh-CN": "选择功能",
        "en": "Select Feature"
    },
    "landing_step_select_desc": {
        "zh-CN": "从侧边栏选择清理数据、性能检测或设置选项。",
        "en": "Select clean data, performance detection, or settings options from the sidebar."
    },
    "landing_step_apply_title": {
        "zh-CN": "应用操作",
        "en": "Apply Actions"
    },
    "landing_step_apply_desc": {
        "zh-CN": "根据需要清理数据、分析性能或配置设置。",
        "en": "Clean data, analyze performance, or configure settings as needed."
    },
    "landing_donate_title": {
        "zh-CN": "支持作者",
        "en": "Support Developer"
    },
    "landing_donate_desc": {
        "zh-CN": "如果您觉得这个扩展对您有帮助，欢迎赞赏支持我继续开发更多实用功能！",
        "en": "If you find this extension helpful, please consider donating to support the development of more useful features!"
    },
    "landing_donate_wechat": {
        "zh-CN": "微信赞赏",
        "en": "WeChat Donation"
    },
    "landing_donate_alipay": {
        "zh-CN": "支付宝赞赏",
        "en": "Alipay Donation"
    },
    "landing_donate_thanks": {
        "zh-CN": "您的支持将帮助我们提供更好的工具和服务",
        "en": "Your support will help us provide better tools and services"
    },
    "landing_supporter_title": {
        "zh-CN": "赞赏墙",
        "en": "Donor Wall"
    },
    "landing_supporter_desc": {
        "zh-CN": "感谢每一位支持者的慷慨赞赏，您的支持是我继续改进产品的动力！",
        "en": "Thank you to all supporters for their generous donations. Your support motivates me to continue improving the product!"
    },
    "landing_supporter_invitation": {
        "zh-CN": "您的名字也可以出现在这里 ↑",
        "en": "Your name could also appear here ↑"
    },
    "landing_reviews_title": {
        "zh-CN": "用户评价",
        "en": "User Reviews"
    },
    "landing_reviews_desc": {
        "zh-CN": "来自真实用户的使用体验和评价",
        "en": "Experiences and reviews from real users"
    },
    "landing_review_1": {
        "zh-CN": "很好用，解决了两天的困扰，很适合开发，还有喜欢干净的人。",
        "en": "Very useful, solved my two-day problem. Great for developers and people who like cleanliness."
    },
    "landing_footer_copyright": {
        "zh-CN": "© 2025 ClearPage. 保留所有权利。",
        "en": "© 2025 ClearPage. All rights reserved."
    },
    "landing_footer_privacy": {
        "zh-CN": "隐私政策",
        "en": "Privacy Policy"
    },
    "landing_footer_contact": {
        "zh-CN": "联系我们",
        "en": "Contact Us"
    }
};

// 整合到i18n.js中
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM加载完成，开始初始化语言设置');

    // ===== 调试帮助函数 =====
    function logDebug(message, data) {
        console.log(`[ClearPage调试] ${message}`, data || '');
    }

    // ===== 直接添加全局翻译辅助函数，确保始终可用 =====
    window.translateElement = function (element, lang) {
        if (!element) return false;

        const key = element.getAttribute('data-i18n');
        if (!key) return false;

        logDebug(`正在翻译元素: ${key}, 当前语言: ${lang}`);

        // 从landingTranslations获取翻译
        if (landingTranslations[key] && landingTranslations[key][lang]) {
            const newText = landingTranslations[key][lang];
            logDebug(`找到翻译: ${key} -> ${newText}`);
            element.textContent = newText;
            // 标记为已处理
            element.setAttribute('data-i18n-processed', 'true');
            return true;
        }

        // 尝试从window.i18n获取翻译
        if (window.i18n && window.i18n.getMessage) {
            const fallback = element.textContent;
            const message = window.i18n.getMessage(key, fallback);
            if (message !== fallback) {
                logDebug(`从i18n获取翻译: ${key} -> ${message}`);
                element.textContent = message;
                // 标记为已处理
                element.setAttribute('data-i18n-processed', 'true');
                return true;
            }
        }

        console.warn(`未找到翻译: ${key}`);
        return false;
    };

    // ===== 获取所有语言切换按钮 =====
    const languageButtons = document.querySelectorAll('.language-btn');

    // ===== 从localStorage获取当前语言设置并初始化按钮状态 =====
    // 此处添加调试代码检查localStorage
    let storedLang = localStorage.getItem('clearpage_language');
    logDebug('从localStorage直接读取的语言: ', storedLang);

    // 尝试修复可能的localStorage问题
    if (!storedLang) {
        storedLang = 'zh-CN';
        localStorage.setItem('clearpage_language', storedLang);
        logDebug('由于localStorage中没有语言设置，设置默认语言为:', storedLang);
    }

    const currentLang = storedLang || 'zh-CN';
    logDebug('当前设置的活动语言:', currentLang);

    // 初始状态下，确保UI反映当前语言设置
    updateButtonState(currentLang);

    // ===== 确保页面初始加载时正确应用语言 =====
    // 立即应用翻译，减少延迟
    applyFullTranslation(currentLang);

    // 额外延迟一点时间再检查一次，确保DOM完全加载
    setTimeout(() => {
        logDebug('延迟检查，确保所有元素已翻译，当前语言:', currentLang);

        // 查找任何未翻译的元素
        const untranslatedElements = document.querySelectorAll('[data-i18n]:not([data-i18n-processed])');
        if (untranslatedElements.length > 0) {
            logDebug(`发现${untranslatedElements.length}个未翻译元素，重新应用翻译`);
            applyFullTranslation(currentLang);
        }

        // 强制检查主页首屏元素
        checkAndFixHomePageElements(currentLang);
    }, 300);

    // ===== 为每个按钮添加点击事件 =====
    languageButtons.forEach(btn => {
        btn.addEventListener('click', function (event) {
            // 阻止默认事件
            event.preventDefault();
            event.stopPropagation();

            const lang = this.getAttribute('data-lang');
            logDebug(`点击了语言按钮: ${lang}`);

            // 切换语言并强制应用UI更新
            updatePageLanguage(lang);

            // 添加延迟检查，确保翻译成功
            setTimeout(() => {
                checkAndFixHomePageElements(lang);
            }, 100);
        });
    });

    // ===== 更新按钮状态的函数 =====
    function updateButtonState(lang) {
        logDebug('更新语言按钮状态:', lang);
        languageButtons.forEach(btn => {
            const btnLang = btn.getAttribute('data-lang');
            if (btnLang === lang) {
                btn.classList.add('active');
                logDebug(`激活按钮: ${btnLang}`);
            } else {
                btn.classList.remove('active');
            }
        });
    }

    // ===== 应用完整翻译的函数 =====
    function applyFullTranslation(lang) {
        logDebug(`应用完整翻译流程，语言: ${lang}`);

        // 1. 重置翻译状态
        document.querySelectorAll('[data-i18n-processed]').forEach(el => {
            el.removeAttribute('data-i18n-processed');
        });

        // 2. 应用基础翻译
        applyPageTranslation(lang);

        // 3. 直接翻译关键元素
        directlyTranslateKeyElements(lang);

        // 4. 特殊处理首页关键元素
        checkAndFixHomePageElements(lang);
    }

    // ===== 手动应用翻译的函数 =====
    function applyPageTranslation(lang) {
        logDebug('应用页面翻译，语言:', lang);

        // 获取所有带data-i18n属性的元素
        const i18nElements = document.querySelectorAll('[data-i18n]:not([data-i18n-processed])');
        logDebug(`找到${i18nElements.length}个需要翻译的元素`);

        // 先将所有元素放入数组以确保完整处理
        const elementsToTranslate = Array.from(i18nElements);

        // 1. 直接翻译所有元素
        let translatedCount = 0;
        elementsToTranslate.forEach(element => {
            const key = element.getAttribute('data-i18n');
            const originalText = element.textContent;

            // 直接应用翻译
            if (landingTranslations[key] && landingTranslations[key][lang]) {
                element.textContent = landingTranslations[key][lang];
                element.setAttribute('data-i18n-processed', 'true');
                translatedCount++;
                logDebug(`直接翻译: ${key} (${originalText} -> ${element.textContent})`);
            } else {
                console.warn(`未找到翻译: ${key} (保持原文: ${originalText})`);
            }
        });

        logDebug(`直接翻译了 ${translatedCount}/${elementsToTranslate.length} 个元素`);

        // 显示语言切换通知
        showLanguageNotification(lang);
    }

    // ===== 直接翻译关键元素，不依赖data-i18n属性 =====
    function directlyTranslateKeyElements(lang) {
        logDebug('直接翻译关键元素');

        const keyTranslations = {
            '.subtitle': landingTranslations.landing_subtitle?.[lang],
            '#installButton': landingTranslations.landing_install_button?.[lang],
            '.section-title:nth-of-type(1)': landingTranslations.landing_features_title?.[lang],
            '.section-title:nth-of-type(2)': landingTranslations.landing_how_to_use_title?.[lang],
            '.section-title:nth-of-type(3)': landingTranslations.landing_donate_title?.[lang],
            '.section-title:nth-of-type(4)': landingTranslations.landing_supporter_title?.[lang],
            '.section-title:nth-of-type(5)': landingTranslations.landing_reviews_title?.[lang]
        };

        // 遍历所有选择器和翻译
        Object.entries(keyTranslations).forEach(([selector, translation]) => {
            if (!translation) return;

            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                if (el.textContent !== translation) {
                    logDebug(`直接翻译关键元素: ${selector} -> ${translation}`);
                    el.textContent = translation;
                }
            });
        });

        // 特别处理各个功能卡片标题和描述
        document.querySelectorAll('.feature-card').forEach((card, index) => {
            const titleEl = card.querySelector('.feature-title');
            const descEl = card.querySelector('p');

            if (titleEl) {
                const titleKeyMap = [
                    'landing_feature_smart_clean_title',
                    'landing_feature_quick_refresh_title',
                    'landing_feature_performance_title',
                    'landing_feature_custom_rules_title',
                    'landing_feature_ui_title',
                    'landing_feature_i18n_title'
                ];

                if (index < titleKeyMap.length) {
                    const key = titleKeyMap[index];
                    if (landingTranslations[key]?.[lang]) {
                        titleEl.textContent = landingTranslations[key][lang];
                    }
                }
            }

            if (descEl) {
                const descKeyMap = [
                    'landing_feature_smart_clean_desc',
                    'landing_feature_quick_refresh_desc',
                    'landing_feature_performance_desc',
                    'landing_feature_custom_rules_desc',
                    'landing_feature_ui_desc',
                    'landing_feature_i18n_desc'
                ];

                if (index < descKeyMap.length) {
                    const key = descKeyMap[index];
                    if (landingTranslations[key]?.[lang]) {
                        descEl.textContent = landingTranslations[key][lang];
                    }
                }
            }
        });

        // 特别处理步骤标题和描述
        document.querySelectorAll('.step').forEach((step, index) => {
            const titleEl = step.querySelector('h3');
            const descEl = step.querySelector('p');

            if (titleEl) {
                const titleKeyMap = [
                    'landing_step_install_title',
                    'landing_step_click_title',
                    'landing_step_select_title',
                    'landing_step_apply_title'
                ];

                if (index < titleKeyMap.length) {
                    const key = titleKeyMap[index];
                    if (landingTranslations[key]?.[lang]) {
                        titleEl.textContent = landingTranslations[key][lang];
                    }
                }
            }

            if (descEl) {
                const descKeyMap = [
                    'landing_step_install_desc',
                    'landing_step_click_desc',
                    'landing_step_select_desc',
                    'landing_step_apply_desc'
                ];

                if (index < descKeyMap.length) {
                    const key = descKeyMap[index];
                    if (landingTranslations[key]?.[lang]) {
                        descEl.textContent = landingTranslations[key][lang];
                    }
                }
            }
        });
    }

    // ===== 特别检查和修复首页关键元素 =====
    function checkAndFixHomePageElements(lang) {
        logDebug('特别检查首页关键元素');

        // 获取并检查副标题元素
        const subtitleEl = document.querySelector('.subtitle');
        if (subtitleEl) {
            const expected = landingTranslations.landing_subtitle?.[lang];
            if (expected && subtitleEl.textContent !== expected) {
                logDebug(`强制修复副标题: ${subtitleEl.textContent} -> ${expected}`);
                subtitleEl.textContent = expected;
            }
        }

        // 获取并检查安装按钮
        const installBtn = document.getElementById('installButton');
        if (installBtn) {
            const expected = landingTranslations.landing_install_button?.[lang];
            if (expected && installBtn.textContent !== expected) {
                logDebug(`强制修复安装按钮: ${installBtn.textContent} -> ${expected}`);
                installBtn.textContent = expected;
            }
        }

        // 翻译所有章节标题
        translateAllSectionTitles(lang);

        // 特别处理功能卡片
        forceTranslateFeatureCards(lang);

        // 特别处理步骤卡片
        forceTranslateStepCards(lang);

        // 特别处理支持作者部分
        forceTranslateSupportSection(lang);

        // 特别处理赞赏墙部分
        forceTranslateDonorWallSection(lang);

        // 特别处理用户评价部分
        forceTranslateReviewsSection(lang);

        // 特别处理页脚部分
        forceTranslateFooterSection(lang);

        // 记录当前页面状态
        logDebug('首页关键元素当前状态已更新');
    }

    // ===== 翻译所有章节标题 =====
    function translateAllSectionTitles(lang) {
        // 章节标题映射
        const sectionTitles = {
            'landing_features_title': {
                selector: '.features .section-title',
                en: 'Key Features',
                zh: '主要功能'
            },
            'landing_how_to_use_title': {
                selector: '.how-to-use .section-title',
                en: 'How To Use',
                zh: '如何使用'
            },
            'landing_donate_title': {
                selector: '.donate .section-title',
                en: 'Support Developer',
                zh: '支持作者'
            },
            'landing_supporter_title': {
                selector: '.supporter-wall .section-title',
                en: 'Donor Wall',
                zh: '赞赏墙'
            },
            'landing_reviews_title': {
                selector: '.review-wall .section-title',
                en: 'User Reviews',
                zh: '用户评价'
            }
        };

        // 遍历所有章节标题并翻译
        Object.entries(sectionTitles).forEach(([key, data]) => {
            const el = document.querySelector(data.selector);
            if (el) {
                const expected = lang === 'en' ? data.en : data.zh;
                if (el.textContent !== expected) {
                    logDebug(`翻译章节标题: ${el.textContent} -> ${expected}`);
                    el.textContent = expected;
                }
            } else {
                logDebug(`警告: 未找到章节标题元素 ${data.selector}`);
            }
        });
    }

    // ===== 强制翻译支持作者部分 =====
    function forceTranslateSupportSection(lang) {
        // 支持作者部分的翻译数据
        const donateData = {
            'landing_donate_desc': {
                selector: '.donate > .container > p:first-of-type',
                en: 'If you find this extension helpful, please consider donating to support the development of more useful features!',
                zh: '如果您觉得这个扩展对您有帮助，欢迎赞赏支持我继续开发更多实用功能！'
            },
            'landing_donate_wechat': {
                selector: '.donate-item:first-child .donate-title',
                en: 'WeChat Donation',
                zh: '微信赞赏'
            },
            'landing_donate_alipay': {
                selector: '.donate-item:last-child .donate-title',
                en: 'Alipay Donation',
                zh: '支付宝赞赏'
            },
            'landing_donate_thanks': {
                selector: '.donate > .container > p[style*="margin-top"]',
                en: 'Your support will help us provide better tools and services',
                zh: '您的支持将帮助我们提供更好的工具和服务'
            }
        };

        // 应用翻译
        Object.entries(donateData).forEach(([key, data]) => {
            const el = document.querySelector(data.selector);
            if (el) {
                const expected = lang === 'en' ? data.en : data.zh;
                if (el.textContent !== expected) {
                    logDebug(`翻译支持作者文本: ${key} -> ${expected}`);
                    el.textContent = expected;
                }
            } else {
                logDebug(`警告: 未找到支持作者元素 ${data.selector}`);
            }
        });
    }

    // ===== 强制翻译赞赏墙部分 =====
    function forceTranslateDonorWallSection(lang) {
        // 赞赏墙部分的翻译数据
        const supporterData = {
            'landing_supporter_desc': {
                selector: '.supporter-wall > .container > p:first-of-type',
                en: 'Thank you to all supporters for their generous donations. Your support motivates me to continue improving the product!',
                zh: '感谢每一位支持者的慷慨赞赏，您的支持是我继续改进产品的动力！'
            },
            'landing_supporter_invitation': {
                selector: '.supporter-wall > .container > p[style*="margin-top"]',
                en: 'Your name could also appear here ↑',
                zh: '您的名字也可以出现在这里 ↑'
            }
        };

        // 应用翻译
        Object.entries(supporterData).forEach(([key, data]) => {
            const el = document.querySelector(data.selector);
            if (el) {
                const expected = lang === 'en' ? data.en : data.zh;
                if (el.textContent !== expected) {
                    logDebug(`翻译赞赏墙文本: ${key} -> ${expected}`);
                    el.textContent = expected;
                }
            } else {
                logDebug(`警告: 未找到赞赏墙元素 ${data.selector}`);
            }
        });
    }

    // ===== 强制翻译用户评价部分 =====
    function forceTranslateReviewsSection(lang) {
        // 用户评价部分的翻译数据
        const reviewsData = {
            'landing_reviews_desc': {
                selector: '.review-wall > .container > p',
                en: 'Experiences and reviews from real users',
                zh: '来自真实用户的使用体验和评价'
            },
            'landing_review_1': {
                selector: '.review-card .review-content',
                en: 'Very useful, solved my two-day problem. Great for developers and people who like cleanliness.',
                zh: '很好用，解决了两天的困扰，很适合开发，还有喜欢干净的人。'
            }
        };

        // 应用翻译
        Object.entries(reviewsData).forEach(([key, data]) => {
            const el = document.querySelector(data.selector);
            if (el) {
                const expected = lang === 'en' ? data.en : data.zh;
                if (el.textContent !== expected) {
                    logDebug(`翻译用户评价文本: ${key} -> ${expected}`);
                    el.textContent = expected;
                }
            } else {
                logDebug(`警告: 未找到用户评价元素 ${data.selector}`);
            }
        });
    }

    // ===== 强制翻译页脚部分 =====
    function forceTranslateFooterSection(lang) {
        // 页脚部分的翻译数据
        const footerData = {
            'landing_footer_copyright': {
                selector: 'footer .container p',
                en: '© 2025 ClearPage. All rights reserved.',
                zh: '© 2025 ClearPage. 保留所有权利。'
            },
            'landing_footer_privacy': {
                selector: 'footer .footer-links a[data-i18n="landing_footer_privacy"]',
                en: 'Privacy Policy',
                zh: '隐私政策'
            },
            'landing_footer_contact': {
                selector: 'footer .footer-links a[data-i18n="landing_footer_contact"]',
                en: 'Contact Us',
                zh: '联系我们'
            }
        };

        // 应用翻译
        Object.entries(footerData).forEach(([key, data]) => {
            const el = document.querySelector(data.selector);
            if (el) {
                const expected = lang === 'en' ? data.en : data.zh;
                if (el.textContent !== expected) {
                    logDebug(`翻译页脚文本: ${key} -> ${expected}`);
                    el.textContent = expected;
                }
            } else {
                logDebug(`警告: 未找到页脚元素 ${data.selector}`);
            }
        });
    }

    // ===== 强制翻译功能卡片 =====
    function forceTranslateFeatureCards(lang) {
        // 卡片标题和描述的映射
        const featureData = [
            {
                titleKey: 'landing_feature_smart_clean_title',
                titleEn: 'Smart Cleaning',
                titleZh: '智能清理',
                descKey: 'landing_feature_smart_clean_desc',
                descEn: 'Supports both smart and custom cleaning modes, accurately cleans cache data of the current website without clearing the entire browser cache.',
                descZh: '支持智能和自定义两种清理模式，精确清理当前网站的缓存数据，无需清理整个浏览器的缓存。'
            },
            {
                titleKey: 'landing_feature_quick_refresh_title',
                titleEn: 'Quick Refresh',
                titleZh: '快速刷新',
                descKey: 'landing_feature_quick_refresh_desc',
                descEn: 'Automatically refreshes the page after cleaning to immediately get the latest content and speed up page loading.',
                descZh: '清理后自动刷新页面，立即获得最新内容，加快网页加载速度。'
            },
            {
                titleKey: 'landing_feature_performance_title',
                titleEn: 'Performance Analysis',
                titleZh: '性能分析',
                descKey: 'landing_feature_performance_desc',
                descEn: 'Comprehensively analyzes page performance metrics, resource distribution, and optimization suggestions, displaying key performance data visually.',
                descZh: '全面分析页面性能指标、资源分布和优化建议，以可视化方式展示关键性能数据。'
            },
            {
                titleKey: 'landing_feature_custom_rules_title',
                titleEn: 'Custom Rules',
                titleZh: '自定义规则',
                descKey: 'landing_feature_custom_rules_desc',
                descEn: 'Create and manage website cleaning rules, supporting import and export of settings to meet personalized needs.',
                descZh: '创建和管理网站清理规则，支持导入导出设置，满足个性化需求。'
            },
            {
                titleKey: 'landing_feature_ui_title',
                titleEn: 'UI Optimization',
                titleZh: '界面优化',
                descKey: 'landing_feature_ui_desc',
                descEn: 'New sidebar navigation design, providing a clearer and more intuitive user experience and operation process.',
                descZh: '全新侧边栏导航设计，提供更清晰直观的用户体验和操作流程。'
            },
            {
                titleKey: 'landing_feature_i18n_title',
                titleEn: 'Multilingual Support',
                titleZh: '多语言支持',
                descKey: 'landing_feature_i18n_desc',
                descEn: 'Supports Chinese and English internationalization to adapt to different user language preferences.',
                descZh: '支持中英文国际化，适应不同用户的语言偏好。'
            }
        ];

        // 直接获取所有功能卡片
        const featureCards = document.querySelectorAll('.feature-card');
        logDebug(`找到 ${featureCards.length} 个功能卡片`);

        if (featureCards.length === 0) {
            logDebug('警告: 未找到功能卡片元素!');
            return;
        }

        // 遍历每个功能卡片
        featureCards.forEach((card, index) => {
            if (index >= featureData.length) return;

            const data = featureData[index];
            const titleEl = card.querySelector('.feature-title');
            const descEl = card.querySelector('p');

            // 翻译标题 - 直接使用硬编码文本以确保覆盖
            if (titleEl) {
                const expectedTitle = lang === 'en' ? data.titleEn : data.titleZh;
                if (titleEl.textContent !== expectedTitle) {
                    logDebug(`强制翻译功能卡片标题 ${index + 1}: ${titleEl.textContent} -> ${expectedTitle}`);
                    titleEl.textContent = expectedTitle;
                }
            } else {
                logDebug(`警告: 卡片 ${index + 1} 未找到标题元素`);
            }

            // 翻译描述
            if (descEl) {
                const expectedDesc = lang === 'en' ? data.descEn : data.descZh;
                if (descEl.textContent !== expectedDesc) {
                    logDebug(`强制翻译功能卡片描述 ${index + 1}: 前几个字符... -> ${expectedDesc.substring(0, 20)}...`);
                    descEl.textContent = expectedDesc;
                }
            } else {
                logDebug(`警告: 卡片 ${index + 1} 未找到描述元素`);
            }
        });
    }

    // ===== 强制翻译使用步骤卡片 =====
    function forceTranslateStepCards(lang) {
        // 步骤数据
        const stepData = [
            {
                titleKey: 'landing_step_install_title',
                titleEn: 'Install Extension',
                titleZh: '安装扩展',
                descKey: 'landing_step_install_desc',
                descEn: 'Install the ClearPage extension from your browser\'s app store.',
                descZh: '从浏览器应用商店安装ClearPage扩展。'
            },
            {
                titleKey: 'landing_step_click_title',
                titleEn: 'Click Icon',
                titleZh: '点击图标',
                descKey: 'landing_step_click_desc',
                descEn: 'Click the ClearPage icon on the website where you need to clean the cache.',
                descZh: '在需要清理缓存的网站上点击ClearPage图标。'
            },
            {
                titleKey: 'landing_step_select_title',
                titleEn: 'Select Feature',
                titleZh: '选择功能',
                descKey: 'landing_step_select_desc',
                descEn: 'Select clean data, performance detection, or settings options from the sidebar.',
                descZh: '从侧边栏选择清理数据、性能检测或设置选项。'
            },
            {
                titleKey: 'landing_step_apply_title',
                titleEn: 'Apply Actions',
                titleZh: '应用操作',
                descKey: 'landing_step_apply_desc',
                descEn: 'Clean data, analyze performance, or configure settings as needed.',
                descZh: '根据需要清理数据、分析性能或配置设置。'
            }
        ];

        // 获取所有步骤卡片
        const stepCards = document.querySelectorAll('.step');
        logDebug(`找到 ${stepCards.length} 个步骤卡片`);

        if (stepCards.length === 0) {
            logDebug('警告: 未找到步骤卡片元素!');
            return;
        }

        // 遍历每个步骤卡片
        stepCards.forEach((card, index) => {
            if (index >= stepData.length) return;

            const data = stepData[index];
            const titleEl = card.querySelector('h3');
            const descEl = card.querySelector('p');

            // 翻译标题 - 直接使用硬编码文本以确保覆盖
            if (titleEl) {
                const expectedTitle = lang === 'en' ? data.titleEn : data.titleZh;
                if (titleEl.textContent !== expectedTitle) {
                    logDebug(`强制翻译步骤卡片标题 ${index + 1}: ${titleEl.textContent} -> ${expectedTitle}`);
                    titleEl.textContent = expectedTitle;
                }
            } else {
                logDebug(`警告: 步骤卡片 ${index + 1} 未找到标题元素`);
            }

            // 翻译描述
            if (descEl) {
                const expectedDesc = lang === 'en' ? data.descEn : data.descZh;
                if (descEl.textContent !== expectedDesc) {
                    logDebug(`强制翻译步骤卡片描述 ${index + 1}: ${descEl.textContent} -> ${expectedDesc}`);
                    descEl.textContent = expectedDesc;
                }
            } else {
                logDebug(`警告: 步骤卡片 ${index + 1} 未找到描述元素`);
            }
        });
    }

    // ===== 显示语言切换通知 =====
    function showLanguageNotification(lang) {
        // 已禁用通知显示
        logDebug(`语言已切换为: ${lang === 'zh-CN' ? '中文' : 'English'} (通知已禁用)`);

        // 移除可能存在的旧通知
        const existingNotification = document.getElementById('language-notification');
        if (existingNotification && document.body.contains(existingNotification)) {
            document.body.removeChild(existingNotification);
        }

        // 不再创建和显示新通知
        return;
    }

    // ===== 处理安装按钮点击事件 =====
    const installButton = document.getElementById('installButton');
    if (installButton) {
        installButton.addEventListener('click', function (e) {
            e.preventDefault();
            // 这里可以添加Chrome商店链接或其他安装指引
            const chromeStoreUrl = "https://chrome.google.com/webstore/detail/your-extension-id";
            window.open(chromeStoreUrl, '_blank');
        });
    }

    // ===== 监听存储变化，以便在其他窗口改变语言时更新 =====
    window.addEventListener('storage', event => {
        if (event.key === 'clearpage_language') {
            logDebug('检测到其他页面更改了语言设置:', event.newValue);
            applyFullTranslation(event.newValue);
        }
    });

    // ===== 全局更新函数 =====
    window.updatePageLanguage = (lang) => {
        logDebug('手动调用语言更新:', lang);

        // 确保lang是有效值
        if (lang !== 'en' && lang !== 'zh-CN') {
            console.warn('无效的语言代码:', lang);
            return '无效的语言代码';
        }

        // 1. 更新localStorage
        localStorage.setItem('clearpage_language', lang);
        logDebug('已设置localStorage中的语言为:', lang);

        // 2. 更新文档lang属性
        document.documentElement.setAttribute('lang', lang);
        logDebug('已更新文档lang属性');

        // 3. 更新按钮状态
        updateButtonState(lang);
        logDebug('已更新按钮状态');

        try {
            // 4. 应用完整翻译流程
            applyFullTranslation(lang);

            // 5. 如果i18n存在，也调用它的方法
            if (window.i18n && window.i18n.switchLanguage) {
                logDebug('调用i18n.switchLanguage:', lang);
                window.i18n.switchLanguage(lang);
            } else {
                logDebug('i18n.switchLanguage不可用，仅使用本地切换');
            }

            // 6. 特别处理各个部分（直接调用多个强制翻译函数，确保应用）
            setTimeout(() => {
                // 翻译所有章节标题
                translateAllSectionTitles(lang);

                // 特别处理功能卡片
                forceTranslateFeatureCards(lang);

                // 特别处理步骤卡片
                forceTranslateStepCards(lang);

                // 特别处理支持作者部分
                forceTranslateSupportSection(lang);

                // 特别处理赞赏墙部分
                forceTranslateDonorWallSection(lang);

                // 特别处理用户评价部分
                forceTranslateReviewsSection(lang);

                // 特别处理页脚部分
                forceTranslateFooterSection(lang);

                logDebug('完成延迟强制翻译所有部分');
            }, 50);

            // 7. 最后延迟检查关键元素
            setTimeout(() => {
                checkAndFixHomePageElements(lang);
                logDebug('完成最终延迟检查');
            }, 200);
        } catch (err) {
            console.error('翻译过程中发生错误:', err);
        }

        return `已将页面语言更新为: ${lang}`;
    };

    // ===== 添加调试日志显示最终的语言状态 =====
    logDebug('语言初始化完成', {
        documentLang: document.documentElement.lang,
        localStorage: localStorage.getItem('clearpage_language'),
        activeButtonLang: document.querySelector('.language-btn.active')?.getAttribute('data-lang')
    });
}); 