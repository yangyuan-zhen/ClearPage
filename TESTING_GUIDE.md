# 登录保护功能测试指南 🔐

## 📋 测试准备

### 1. 构建扩展

```bash
npm run build
```

### 2. 加载扩展到 Chrome

1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 开启右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目的 `dist` 文件夹

---

## 🧪 登录保护功能测试步骤

### 测试场景 1：添加网站到白名单

#### 步骤：

1. **访问测试网站**
   - 推荐测试网站：
     - GitHub: https://github.com
     - 微博: https://weibo.com
     - Bilibili: https://bilibili.com
2. **登录账号**

   - 确保您已登录该网站

3. **打开扩展**

   - 点击浏览器工具栏中的扩展图标

4. **添加到白名单**
   - 在扩展弹窗顶部找到"保护登录"按钮
   - 点击按钮
   - 按钮应该变为绿色"已保护"状态
   - 下方应显示提示："✓ 登录已保护，清理时将保留 Cookies"

#### 预期结果：

✅ 按钮状态变为"已保护"（绿色）
✅ 显示保护提示信息
✅ 白名单已保存到 chrome.storage

---

### 测试场景 2：清理时保留 Cookies

#### 步骤：

1. **确认网站在白名单中**

   - 查看是否显示"登录已保护"提示

2. **选择包含 Cookies 的清理选项**

   - 勾选"缓存"
   - 勾选"Cookies"
   - 可选择其他数据类型

3. **执行清理**

   - 点击顶部的"立即清理"按钮（绿色大按钮）
   - 等待清理完成

4. **刷新页面**

   - 刷新当前网站页面

5. **检查登录状态**
   - 确认您仍然保持登录状态
   - 不需要重新输入用户名和密码

#### 预期结果：

✅ 清理成功完成
✅ **登录状态保持**（关键！）
✅ 页面功能正常
✅ 缓存被清除（页面可能加载稍慢）

---

### 测试场景 3：移除白名单后清理

#### 步骤：

1. **移除白名单保护**

   - 再次点击"已保护"按钮
   - 按钮应变回"保护登录"状态（灰色）

2. **选择清理选项**

   - 勾选"Cookies"

3. **执行清理**

   - 点击"立即清理"
   - 应该弹出确认对话框（因为包含敏感数据）
   - 点击"确认清理"

4. **刷新页面**

   - 刷新当前网站页面

5. **检查登录状态**
   - 此时应该**已退出登录**
   - 需要重新登录

#### 预期结果：

✅ 弹出确认对话框
✅ 清理成功
✅ **登录状态被清除**（符合预期）
✅ 需要重新登录

---

## 🔍 调试检查

### 检查白名单是否保存

#### 方法 1：开发者工具

1. 按 `F12` 打开开发者工具
2. 切换到 **Console** 标签
3. 输入以下代码：

```javascript
chrome.storage.sync.get("cookieWhitelist", (data) => {
  console.log("白名单:", data.cookieWhitelist);
});
```

4. 查看控制台输出

#### 方法 2：扩展存储查看器

1. 访问 `chrome://extensions/`
2. 找到您的扩展
3. 点击"检查视图" → "background page"
4. 在控制台中输入上述代码

### 检查清理日志

在扩展的 background 页面控制台中，查看：

```javascript
// 应该看到类似的日志：
// "收到清理缓存请求" {domain: "github.com", dataTypes: ["cache", "cookies"], autoRefresh: false, whitelist: ["github.com"]}
// "域名 github.com 在白名单中，跳过 cookies 清理"
```

---

## ✅ 成功标准

登录保护功能正常工作的标志：

1. **白名单添加/移除**

   - ✅ 点击按钮能正常切换状态
   - ✅ 白名单数据正确保存
   - ✅ 状态提示清晰可见

2. **清理时保护 Cookies**

   - ✅ 白名单网站的 Cookies 不被清除
   - ✅ 登录状态保持不变
   - ✅ 其他数据类型正常清除

3. **非白名单网站**
   - ✅ 未保护的网站 Cookies 正常清除
   - ✅ 确认对话框正常弹出
   - ✅ 清除后需要重新登录

---

## 🐛 常见问题排查

### 问题 1：点击"保护登录"无反应

**解决方案：**

- 检查控制台是否有错误
- 确认 `chrome.storage` 权限已授予
- 重新加载扩展

### 问题 2：保护后仍然被清除登录

**检查项：**

- 打开 background 页面控制台
- 查看是否有 "域名 xxx 在白名单中，跳过 cookies 清理" 日志
- 确认白名单中确实保存了该域名
- 检查域名是否匹配（www.example.com vs example.com）

### 问题 3：白名单数据丢失

**可能原因：**

- 使用了 `chrome.storage.local` 而非 `sync`
- 浏览器同步功能未开启
- 扩展被重新加载

---

## 📊 测试记录表

您可以使用以下表格记录测试结果：

| 测试项       | 网站       | 是否成功 | 备注 |
| ------------ | ---------- | -------- | ---- |
| 添加白名单   | github.com | ☐        |      |
| 清理保持登录 | github.com | ☐        |      |
| 移除白名单   | github.com | ☐        |      |
| 清除登录     | github.com | ☐        |      |
| 添加白名单   | weibo.com  | ☐        |      |
| 清理保持登录 | weibo.com  | ☐        |      |

---

## 🎯 快速测试流程

**5 分钟快速验证：**

1. ✅ 访问 GitHub 并登录
2. ✅ 打开扩展，点击"保护登录"
3. ✅ 选择"缓存" + "Cookies"，点击"立即清理"
4. ✅ 刷新页面，确认仍然登录
5. ✅ 点击"已保护"取消保护
6. ✅ 再次清理，刷新页面，确认已退出登录

**如果以上 6 步都通过，说明登录保护功能完全正常！** ✨

---

## 💡 提示

- 建议在**无痕模式**下测试，避免其他扩展干扰
- 测试前先做好重要网站的密码备份
- 可以使用测试账号进行测试
- 记录每次测试的结果以便追踪问题

---

**祝测试顺利！如有任何问题，请查看控制台日志进行调试。** 🎉
